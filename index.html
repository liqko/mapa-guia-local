<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Comercios Adheridos - Guía Local Dolores</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .popup-logo {
      width: 100px;
      height: auto;
      display: block;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-36.313, -57.679], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    function normalizarCategoria(nombre) {
      return nombre
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // elimina tildes
        .replace(/\s+/g, '-')            // espacios por guiones
        .replace(/[^a-z0-9\-]/g, '');    // solo letras, números y guiones
    }

    const url = 'https://opensheet.elk.sh/1vwzXhaK99qos9PsZo-MLysJ8okR81VZV1EXgFiweUWW/ADHERIDOS';

    fetch(url)
      .then(response => response.json())
      .then(data => {
        data.forEach(comercio => {
          if (comercio.lat && comercio.lng) {
            const lat = parseFloat(comercio.lat / 1e7);
            const lng = parseFloat(comercio.lng / 1e7);
            const categoria = normalizarCategoria(comercio.categoria || 'default');

            const iconoCategoria = L.icon({
              iconUrl: `img/${categoria}.png`,
              iconSize: [40, 40],
              iconAnchor: [20, 40],
              popupAnchor: [0, -40]
            });

            const marker = L.marker([lat, lng], { icon: iconoCategoria }).addTo(map);

            const popupHTML = `
              <img class="popup-logo" src="logos/${comercio.logo}" alt="Logo">
              <strong>${comercio.nombre}</strong><br>
              <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank">¿Cómo llegar?</a>
            `;

            marker.bindPopup(popupHTML);
          }
        });
      })
      .catch(error => {
        console.error('Error al cargar los datos:', error);
      });
  </script>
</body>
</html>
